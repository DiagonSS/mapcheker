<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gardener Service Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@500&family=Open+Sans:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            background-image: url('https://www.transparenttextures.com/patterns/green-dust.png');
            background-color: #f5f5f0;
            font-family: 'Open Sans', sans-serif;
        }
        #map { height: 400px; border-radius: 10px; border: 2px solid #4a7043; }
        .spinner {
            border: 4px solid #d4e4d0;
            border-top: 4px solid #4a7043;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            font-family: 'Lora', serif;
            color: #2f4f2f;
        }
        input, button {
            transition: all 0.3s ease;
        }
        button:hover {
            transform: scale(1.05);
        }
        a {
            color: #16a34a;
            text-decoration: underline;
        }
        a:hover {
            color: #15803d;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full border border-green-200">
        <h1 class="text-3xl font-bold mb-6 text-center">Gardener Service Area</h1>
        <div id="map" class="mb-6"></div>
        <div class="flex flex-col gap-4">
            <input id="postcodeInput" type="text" placeholder="Enter your postcode (e.g., M20 2BA)" class="p-3 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-green-50">
            <button id="checkButton" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700">Check Service Area</button>
            <div id="spinner" class="spinner"></div>
            <p id="result" class="text-center font-medium text-gray-800"></p>
        </div>
    </div>

    <script>
        // Initialize Leaflet map centered between Manchester and OL9 9PD
        const map = L.map('map').setView([53.5113, -2.1919], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Define service areas: 8 miles around Manchester, 10 miles around OL9 9PD
        const manchesterCircle = turf.circle([-2.2426, 53.4808], 8 * 1.60934, { steps: 64, units: 'kilometers' });
        const ol9Circle = turf.circle([-2.1413, 53.5417], 10 * 1.60934, { steps: 64, units: 'kilometers' });

        // Union of the two circles to create a single service area
        const serviceAreaUnion = turf.union(manchesterCircle, ol9Circle);

        // Add the union polygon to the map with gardening theme
        const serviceAreaLayer = L.geoJSON(serviceAreaUnion, {
            style: {
                color: '#2f4f2f', // Dark green outline
                fillColor: '#90ee90', // Light green fill
                fillOpacity: 0.3,
                weight: 2
            }
        }).addTo(map);

        // Validate UK postcode format
        function isValidPostcode(postcode) {
            const regex = /^[A-Z]{1,2}[0-9]{1,2} ?[0-9][A-Z]{2}$/;
            return regex.test(postcode.toUpperCase());
        }

        // Check if point is inside the service area
        function isPointInServiceArea(lat, lng) {
            const point = turf.point([lng, lat]);
            return turf.booleanPointInPolygon(point, serviceAreaUnion);
        }

        // Fetch coordinates from Postcodes.io API
        async function getCoordinates(postcode) {
            try {
                const response = await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(postcode)}`);
                const data = await response.json();
                if (data.status === 200) {
                    return { lat: data.result.latitude, lng: data.result.longitude };
                } else {
                    throw new Error('Invalid postcode');
                }
            } catch (error) {
                throw new Error('Error fetching postcode data');
            }
        }

        // Handle button click
        document.getElementById('checkButton').addEventListener('click', async () => {
            const postcode = document.getElementById('postcodeInput').value.trim().toUpperCase();
            const resultElement = document.getElementById('result');
            const spinner = document.getElementById('spinner');
            const checkButton = document.getElementById('checkButton');

            if (!isValidPostcode(postcode)) {
                resultElement.innerHTML = 'Invalid postcode format. Please use format like M20 2BA.';
                resultElement.classList.remove('text-green-600');
                resultElement.classList.add('text-red-600');
                return;
            }

            // Show spinner, disable button
            spinner.style.display = 'block';
            checkButton.disabled = true;

            try {
                const { lat, lng } = await getCoordinates(postcode);
                map.setView([lat, lng], 12);

                if (isPointInServiceArea(lat, lng)) {
                    resultElement.innerHTML = 'Gardening services available in your area!';
                    resultElement.classList.remove('text-red-600');
                    resultElement.classList.add('text-green-600');
                } else {
                    resultElement.innerHTML = 'Sorry, gardening services are not available in your area. <a href="mailto:info@gardener.com">Contact us</a>, we may be able to help if you\'re not too far!';
                    resultElement.classList.remove('text-green-600');
                    resultElement.classList.add('text-red-600');
                }
            } catch (error) {
                resultElement.innerHTML = 'Error: Unable to verify postcode. Please try again.';
                resultElement.classList.remove('text-green-600');
                resultElement.classList.add('text-red-600');
            } finally {
                // Hide spinner, enable button
                spinner.style.display = 'none';
                checkButton.disabled = false;
            }
        });
    </script>
</body>
</html>